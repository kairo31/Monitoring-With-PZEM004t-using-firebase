<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Power Monitoring - Professional Thesis Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50; --primary-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --success: #1cc88a; --warning: #f6c23e; --danger: #e74a3b; 
            --dark: #2a2d34; --light: #f8f9fc; --info: #36b9cc;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        body { font-family: 'Poppins', sans-serif; background-color: var(--light); margin: 0; padding: 25px 20px; color: var(--dark); display: flex; flex-direction: column; align-items: center; }
       
        .header { background: var(--primary-gradient); color: white; width: 100%; max-width: 1100px; padding: 30px; text-align: center; border-radius: 20px; margin-bottom: 25px; animation: fadeInUp 0.5s ease-out; }

        .grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; width: 100%; max-width: 1100px; margin-bottom: 25px; }
        .card-small { background: white; border-radius: 16px; padding: 20px; text-align: center; box-shadow: var(--card-shadow); border-bottom: 5px solid var(--primary); transition: transform 0.3s; animation: fadeInUp 0.7s ease-out backwards; }
        .card-small:hover { transform: translateY(-5px); }
        .card-small .value { font-size: 1.2rem; font-weight: 800; display: block; margin-top: 5px; }

        .card-main { background: white; border-radius: 20px; padding: 40px; box-shadow: var(--card-shadow); width: 100%; max-width: 1100px; margin-bottom: 25px; text-align: center; border: 1px solid #eaecf4; animation: fadeInUp 0.9s ease-out backwards; }
        .big-watt { font-size: 5rem; font-weight: 900; color: var(--primary); margin: 0; line-height: 1; }
        
        .cost-box { margin: 20px 0; padding: 15px; border-radius: 12px; background: #f8f9fc; display: inline-block; }
        #valBiayaHariIni { color: var(--success); font-size: 1.8rem; font-weight: 800; display: block; }
        
        .device-tag { font-weight: 700; padding: 8px 25px; border-radius: 50px; background: #e9ecef; color: var(--primary); margin-bottom: 20px; display: inline-block; }

        .ai-section { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; border-top: 2px dashed #eee; padding-top: 25px; }
        .ai-val { font-size: 1.4rem; font-weight: 800; color: var(--warning); }

        .card-chart { background: white; border-radius: 20px; padding: 25px; box-shadow: var(--card-shadow); width: 100%; max-width: 1100px; margin-bottom: 25px; animation: fadeInUp 1.1s ease-out backwards; }
        .chart-container { height: 300px; width: 100%; }
        
        .grid-charts { display: grid; grid-template-columns: repeat(auto-fit, minmax(340px, 1fr)); gap: 20px; width: 100%; max-width: 1100px; }

        @media (max-width: 768px) { .grid-container { grid-template-columns: repeat(2, 1fr); } .big-watt { font-size: 3.5rem; } }
    </style>
</head>
<body>

    <div class="header">
        <h1>Smart Power Monitoring</h1>
        <p>Analisis Energi 900VA Non-Subsidi | Tesis Mekatronika Kairo</p>
    </div>

    <div class="grid-container">
        <div class="card-small" style="border-bottom-color: var(--primary);"><h3>Tegangan</h3><span class="value" id="valVolt">0 V</span></div>
        <div class="card-small" style="border-bottom-color: var(--success);"><h3>Arus</h3><span class="value" id="valArus">0 A</span></div>
        <div class="card-small" style="border-bottom-color: #e67e22;"><h3>Total kWh</h3><span class="value" id="valEnergy">0.0000</span></div>
        <div class="card-small" style="border-bottom-color: var(--info);"><h3>Suhu In</h3><span class="value" id="valSuhuIn">--°C</span></div>
        <div class="card-small" style="border-bottom-color: var(--danger);"><h3>Suhu Out</h3><span class="value" id="valSuhuOut">--°C</span></div>
    </div>

    <div class="card-main">
        <h3>Daya Aktif Saat Ini</h3>
        <div class="big-watt"><span id="valDaya">0</span> W</div>
        
        <div class="cost-box">
            <span style="font-size: 0.9rem; color: #a0a5b1; font-weight: 600;">ESTIMASI BIAYA HARI INI</span>
            <span id="valBiayaHariIni">Rp 0</span>
        </div>

        <div id="valDevice" class="device-tag">Menganalisa Beban...</div>
        
        <div class="ai-section">
            <div><div style="font-size:0.8rem; font-weight:700; color:#a0a5b1">PREDIKSI SARIMAX</div><div class="ai-val" id="valAi">0 W</div></div>
            <div style="border-left: 2px solid #eee;"><div style="font-size:0.8rem; font-weight:700; color:#a0a5b1">REKOMENDASI RL</div><div class="ai-val" id="valRl" style="color: var(--success);">Stable</div></div>
        </div>
    </div>

    <div class="card-chart">
        <h3>Tren Konsumsi Daya (Real-time Watt)</h3>
        <div class="chart-container"><canvas id="chartWatt"></canvas></div>
    </div>

    <div class="grid-charts">
        <div class="card-chart">
            <h3>Perbandingan Suhu (°C)</h3>
            <div class="chart-container"><canvas id="chartSuhu"></canvas></div>
        </div>

        <div class="card-chart">
            <h3>Konsumsi Energi Per Jam (Wh)</h3>
            <div class="chart-container"><canvas id="chartJam"></canvas></div>
        </div>

        <div class="card-chart">
            <h3>Total Penggunaan Harian (kWh)</h3>
            <div class="chart-container"><canvas id="chartHarian"></canvas></div>
        </div>
    </div>

<script>
    const firebaseConfig = { databaseURL: "https://test-reading-the-pzem-default-rtdb.asia-southeast1.firebasedatabase.app" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Default Chart Config
    Chart.defaults.font.family = "'Poppins', sans-serif";
    const chartOptions = { responsive: true, maintainAspectRatio: false, animation: { duration: 1000 } };

    let liveW = 0, liveSIn = 0, liveSOut = 27;

    // Inisialisasi 4 Grafik
    const ctxWatt = new Chart(document.getElementById('chartWatt'), { type: 'line', data: { labels: [], datasets: [{ label: 'Watt', data: [], borderColor: '#2c3e50', fill: true, backgroundColor: 'rgba(44,62,80,0.05)', tension: 0.4 }]}, options: chartOptions });
    const ctxSuhu = new Chart(document.getElementById('chartSuhu'), { type: 'line', data: { labels: [], datasets: [{ label: 'Indoor', borderColor: '#36b9cc', data: [] }, { label: 'Outdoor', borderColor: '#e74a3b', borderDash: [5,5], data: [] }]}, options: chartOptions });
    const ctxJam = new Chart(document.getElementById('chartJam'), { type: 'bar', data: { labels: [], datasets: [{ label: 'Wh', backgroundColor: '#f6c23e', data: [] }]}, options: chartOptions });
    const ctxHarian = new Chart(document.getElementById('chartHarian'), { type: 'bar', data: { labels: [], datasets: [{ label: 'kWh', backgroundColor: '#1cc88a', data: [] }]}, options: chartOptions });

    // 1. Ambil Data Real-time (Monitoring)
    db.ref('Monitoring').on('value', (s) => {
        const d = s.val(); if(!d) return;
        liveW = d.Daya || 0; liveSIn = d.Suhu || 0;
        document.getElementById('valVolt').innerText = (d.Tegangan || 0).toFixed(1) + " V";
        document.getElementById('valArus').innerText = (d.Arus || 0).toFixed(3) + " A";
        document.getElementById('valEnergy').innerText = (d.Energy || 0).toFixed(4);
        document.getElementById('valSuhuIn').innerText = liveSIn.toFixed(1) + "°C";
        document.getElementById('valDaya').innerText = liveW.toFixed(1);
        
        let dev = "Standby";
        if(liveW > 300) dev = "Beban Berat (AC/Pemanas)"; else if(liveW > 50) dev = "Beban Menengah";
        document.getElementById('valDevice').innerText = dev;
    });

    // 2. Ambil Hasil Rekap Python (dashboard_info)
    db.ref('dashboard_info').on('value', (s) => {
        const d = s.val(); if(!d) return;
        document.getElementById('valBiayaHariIni').innerText = "Rp " + d.biaya_hari_ini.toLocaleString('id-ID');
    });

    // 3. Ambil History Harian (chartHarian)
    db.ref('rekap_harian/history').limitToLast(7).on('value', (s) => {
        const d = s.val(); if(!d) return;
        const labels = Object.keys(d);
        const values = labels.map(k => d[k].penggunaan_kwh);
        ctxHarian.data.labels = labels; ctxHarian.data.datasets[0].data = values; ctxHarian.update();
    });

    // 4. Ambil Data Per Jam (chartJam)
    db.ref('Kwh_Jam').limitToLast(24).on('value', (s) => {
        const d = s.val(); if(!d) return;
        ctxJam.data.labels = Object.keys(d).map(k => d[k].jam + ":00");
        ctxJam.data.datasets[0].data = Object.keys(d).map(k => d[k].wh_pakai);
        ctxJam.update();
    });

    // 5. Prediksi & RL
    db.ref('Prediksi').on('value', (s) => {
        const d = s.val(); if(!d) return;
        document.getElementById('valAi').innerText = (d.next_watt || 0).toFixed(1) + " W";
        document.getElementById('valRl').innerText = d.advice || "Stable";
    });

    // Weather & Real-time Graph Update
    async function getOutTemp() {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=Purwokerto&appid=beefa531dea387fcb2f8ee59a46d472c&units=metric`);
        const data = await res.json(); if(data.main) { liveSOut = data.main.temp; document.getElementById('valSuhuOut').innerText = liveSOut.toFixed(1) + "°C"; }
    }
    getOutTemp();

    setInterval(() => {
        const now = new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        
        // Update Watt Chart
        ctxWatt.data.labels.push(now); ctxWatt.data.datasets[0].data.push(liveW);
        if(ctxWatt.data.labels.length > 15) { ctxWatt.data.labels.shift(); ctxWatt.data.datasets[0].data.shift(); }
        ctxWatt.update('none');

        // Update Suhu Chart
        ctxSuhu.data.labels.push(now); ctxSuhu.data.datasets[0].data.push(liveSIn); ctxSuhu.data.datasets[1].data.push(liveSOut);
        if(ctxSuhu.data.labels.length > 15) { ctxSuhu.data.labels.shift(); ctxSuhu.data.datasets[0].data.shift(); ctxSuhu.data.datasets[1].data.shift(); }
        ctxSuhu.update('none');
    }, 10000);
</script>
</body>
</html>
